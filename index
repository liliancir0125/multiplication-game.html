<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰ä¼Šå¡å“‡ä¹ä¹ä¹˜æ³•å­¸ç¿’æ©Ÿ</title>
    <style>
        :root {
            --pink: #ffb8d1;
            --blue: #89cff0;
            --yellow: #fff59d;
            --text: #5d4037;
            --green: #77dd77;
            --red: #ff6961;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            color: var(--text);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #fff9fb;
            background-image: radial-gradient(var(--pink) 1.5px, transparent 1.5px), 
                              radial-gradient(var(--blue) 1.5px, transparent 1.5px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        .header {
            width: 90%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }

        .sound-btn {
            background: var(--white);
            border: 3px solid var(--blue);
            border-radius: 50px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 0 var(--blue);
            transition: transform 0.1s;
        }

        .mode-selector {
            background: var(--pink);
            padding: 5px;
            border-radius: 50px;
            display: flex;
            box-shadow: 0 4px 0 #e0a0b8;
        }

        .mode-tab {
            padding: 8px 20px;
            border-radius: 50px;
            border: none;
            background: transparent;
            font-weight: bold;
            cursor: pointer;
        }

        .mode-tab.active {
            background: var(--white);
        }

        /* éŠæˆ²ä¸»å¡ç‰‡ */
        .card {
            width: 90%;
            max-width: 400px;
            background: var(--white);
            border: 8px solid var(--yellow);
            border-radius: 40px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(255, 184, 209, 0.3);
            margin-bottom: 20px;
            position: relative;
        }

        .range-select {
            margin-bottom: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid var(--pink);
            font-size: 1rem;
            outline: none;
        }

        .display-area {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .display-area span { color: var(--blue); }
        .answer-box {
            display: inline-block;
            min-width: 80px;
            border-bottom: 5px solid var(--pink);
            color: var(--pink);
            margin-left: 10px;
        }

        /* è™›æ“¬éµç›¤ */
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 90%;
            max-width: 400px;
            padding: 10px;
        }

        .key {
            background: var(--white);
            border: 3px solid var(--blue);
            border-radius: 25px;
            padding: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 var(--blue);
            transition: all 0.1s;
        }

        .key:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 var(--blue);
        }

        .key.special { background: var(--pink); border-color: #e0a0b8; box-shadow: 0 5px 0 #e0a0b8; color: white; }
        .key.ok { background: var(--yellow); border-color: #f0e68c; box-shadow: 0 5px 0 #f0e68c; }

        /* èƒŒèª¦æ¨¡å¼å°è¦½ */
        .nav-controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }

        .nav-btn {
            background: var(--blue);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            box-shadow: 0 5px 0 #6eb5d8;
        }

        /* å›é¥‹å‹•ç•« */
        .feedback {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            z-index: 100;
        }

        .pop { animation: popAnim 0.8s ease-out forwards; }
        @keyframes popAnim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="sound-btn" onclick="toggleMute()" id="muteBtn">ğŸ”” è²éŸ³é–‹å•Ÿ</button>
        <div class="mode-selector">
            <button class="mode-tab active" onclick="switchMode('recite')">èƒŒèª¦</button>
            <button class="mode-tab" onclick="switchMode('quiz')">æ¸¬é©—</button>
        </div>
    </div>

    <div class="card">
        <select class="range-select" id="rangeSelect" onchange="initGame()">
            <option value="1">1 çš„ä¹˜æ³•</option>
            <option value="2">2 çš„ä¹˜æ³•</option>
            <option value="3">3 çš„ä¹˜æ³•</option>
            <option value="4">4 çš„ä¹˜æ³•</option>
            <option value="5">5 çš„ä¹˜æ³•</option>
            <option value="6">6 çš„ä¹˜æ³•</option>
            <option value="7">7 çš„ä¹˜æ³•</option>
            <option value="8">8 çš„ä¹˜æ³•</option>
            <option value="9">9 çš„ä¹˜æ³•</option>
            <option value="random">ğŸŒŸ ç¶œåˆå¤§æŒ‘æˆ°</option>
        </select>

        <div class="display-area" id="displayArea">
            </div>

        <div id="reciteControls" class="nav-controls">
            <button class="nav-btn" onclick="prevStep()">ä¸Šä¸€å€‹</button>
            <button class="nav-btn" onclick="nextStep()">ä¸‹ä¸€å€‹</button>
        </div>
    </div>

    <div class="keypad" id="keypad" style="display: none;">
        <button class="key" onclick="pressNum(1)">1</button>
        <button class="key" onclick="pressNum(2)">2</button>
        <button class="key" onclick="pressNum(3)">3</button>
        <button class="key" onclick="pressNum(4)">4</button>
        <button class="key" onclick="pressNum(5)">5</button>
        <button class="key" onclick="pressNum(6)">6</button>
        <button class="key" onclick="pressNum(7)">7</button>
        <button class="key" onclick="pressNum(8)">8</button>
        <button class="key" onclick="pressNum(9)">9</button>
        <button class="key special" onclick="pressNum('C')">C</button>
        <button class="key" onclick="pressNum(0)">0</button>
        <button class="key ok" onclick="checkAnswer()">OK</button>
    </div>

    <div class="feedback" id="feedback"></div>

    <script>
        let currentMode = 'recite';
        let currentNum = 2;
        let currentStep = 1;
        let quizA = 2, quizB = 1;
        let userInput = "";
        let isMuted = false;

        const praiseWords = ["ä½ çœŸæ£’ï¼", "å¤ªå¼·äº†ï¼", "ä¸€ç™¾åˆ†ï¼", "å¥½å²å®³ï¼", "è¶…ç´šå„ªç§€ï¼"];
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”• å·²éœéŸ³" : "ğŸ”” è²éŸ³é–‹å•Ÿ";
        }

        function speak(text) {
            if (isMuted) return;
            // ä¿®æ­£ç™¼éŸ³ï¼šå°‡ã€Œä¹˜ã€æ”¹ç‚ºã€Œæˆã€
            const fixedText = text.replace(/Ã—/g, "æˆä»¥").replace(/ä¹˜/g, "æˆ");
            const utterance = new SpeechSynthesisUtterance(fixedText);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }

        function playDingDong() {
            if (isMuted) return;
            const playNote = (freq, start) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, start);
                gain.gain.setValueAtTime(0.1, start);
                gain.gain.exponentialRampToValueAtTime(0.01, start + 0.4);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(start);
                osc.stop(start + 0.4);
            };
            playNote(523.25, audioCtx.currentTime); // C5
            playNote(783.99, audioCtx.currentTime + 0.15); // G5
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === (mode === 'recite' ? 'èƒŒèª¦' : 'æ¸¬é©—'));
            });
            document.getElementById('reciteControls').style.display = (mode === 'recite' ? 'flex' : 'none');
            document.getElementById('keypad').style.display = (mode === 'quiz' ? 'grid' : 'none');
            initGame();
        }

        function initGame() {
            const range = document.getElementById('rangeSelect').value;
            userInput = "";
            if (currentMode === 'recite') {
                if (range !== 'random') currentNum = parseInt(range);
                currentStep = 1;
                renderRecite();
            } else {
                generateQuiz();
            }
        }

        function renderRecite() {
            const display = document.getElementById('displayArea');
            const ans = currentNum * currentStep;
            const text = `${currentNum} Ã— ${currentStep} = ${ans}`;
            display.innerHTML = `<div>${currentNum} <span>Ã—</span> ${currentStep} = ${ans}</div>`;
            speak(text);
        }

        function nextStep() {
            if (currentStep < 9) { currentStep++; renderRecite(); }
            else if (document.getElementById('rangeSelect').value === 'random') {
                currentNum = Math.floor(Math.random() * 8) + 2;
                currentStep = 1;
                renderRecite();
            }
        }

        function prevStep() {
            if (currentStep > 1) { currentStep--; renderRecite(); }
        }

        function generateQuiz() {
            const range = document.getElementById('rangeSelect').value;
            if (range === 'random') {
                quizA = Math.floor(Math.random() * 8) + 2;
            } else {
                quizA = parseInt(range);
            }
            quizB = Math.floor(Math.random() * 9) + 1;
            userInput = "";
            renderQuiz();
            speak(`${quizA} ä¹˜ ${quizB} ç­‰æ–¼å¤šå°‘ï¼Ÿ`);
        }

        function renderQuiz() {
            const display = document.getElementById('displayArea');
            display.innerHTML = `<div>${quizA} <span>Ã—</span> ${quizB} = <span class="answer-box">${userInput || '?'}</span></div>`;
        }

        function pressNum(n) {
            if (n === 'C') {
                userInput = "";
            } else {
                if (userInput.length < 2) {
                    userInput += n;
                    speak(n.toString());
                }
            }
            renderQuiz();
        }

        function checkAnswer() {
            const correct = quizA * quizB;
            const fb = document.getElementById('feedback');
            
            if (parseInt(userInput) === correct) {
                fb.innerText = "â­ ç­”å°äº†ï¼";
                fb.style.color = "var(--green)";
                fb.className = "feedback pop";
                
                playDingDong();
                setTimeout(() => speak("ç­”å°äº†"), 600);
                setTimeout(() => {
                    const praise = praiseWords[Math.floor(Math.random() * praiseWords.length)];
                    speak(praise);
                }, 1400);

                setTimeout(() => {
                    fb.className = "feedback";
                    generateQuiz();
                }, 2500);
            } else {
                fb.innerText = "âŒ å†è©¦ä¸€æ¬¡";
                fb.style.color = "var(--red)";
                fb.className = "feedback pop";
                speak("ä¸å°å–”ï¼Œå†è©¦ä¸€æ¬¡");
                setTimeout(() => {
                    fb.className = "feedback";
                    userInput = "";
                    renderQuiz();
                }, 1200);
            }
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            initGame();
        };
    </script>
</body>
</html>
